<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<!-- 
The MIT License (MIT)

Copyright (c) 2013 RÃ©mi Arnaud - Advanced Micro Devices, Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
 -->
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">

    <script type="text/javascript" src="../gui/gui6.js"></script>

    <script type="text/javascript" src="renderer.js"></script>
    <script type="text/javascript" src="/loaders/collada.js"></script>
    <script type="text/javascript" src="/loaders/gltf.js"></script>
    <link rel="stylesheet" href="../gui/gui6.css"/>   
    <script type="text/javascript" src="../deps/console.js"></script>
    <script type="text/javascript">
    
    $("document").ready(function () {
        "use strict";
        if (!window.performance) {
            window.performance = {};
            window.performance.now = $.now
        };
        var listThemes = ["black-tie", "blitzer", "cupertino", "dark-hive", "dot-luv", "eggplant", "excite-bike", "flick", "hot-sneaks", "humanity", "le-frog", "mint-choc", "overcast", "pepper-grinder", "redmond", "smoothness", "south-street", "start", "sunny", "swanky-purse", "trontastic", "ui-darkness", "ui-lightness", "vader"];
        var renderMenu = $('');
        var flagStatus = false;
        var url = "http://www.google.com/custom?q=fl4re&btnG=Search";

        window.fl4reStatus = function (type, text, _parent) {
            $('#copyButton').remove();
            $('#iconStatus').remove();
            $('#defaultText').remove();
            $('#defaultTextBis').remove();
            if (type == 'CLEAR' || type == 'READY') {
                GUI.label("defaultText", "ready", _parent);
                GUI.addIcon(_parent, "ui-icon-circle-check", "float:left;margin:3px;", "before").attr('id', 'iconStatus');
            } else if (type == 'BUSY') {
                GUI.label("defaultText", text, _parent);
                GUI.addIcon(_parent, "ui-icon-clock", "float:left;margin:3px;", "before").attr('id', 'iconStatus');;
            } else if (type == 'ERROR') {
                GUI.label("defaultText", text, _parent);
                GUI.addIcon($("#mainLayout-south"), "ui-icon-circle-close", "float:left;margin:3px;", "before").attr('id', 'iconStatus');;
            } else if (type == 'WARNING') {
                GUI.label("defaultText", text, _parent);
                GUI.addIcon($("#mainLayout-south"), "ui-icon-alert", "float:left;margin:3px;", "before").attr('id', 'iconStatus');;
            } else {
                var label = GUI.label("defaultTextBis", text, _parent);
                GUI.addIcon(_parent, "ui-icon-info", "float:left;margin:3px;", "before").attr('id', 'iconStatus');
                var clear = GUI.button("Clear", label, function () {
                    GUI.copyToClipboard(text.slice(15, -1));
                    GUI.addTooltip({
                        parent: $('this'),
                        content: "copy completed!"
                    });
                });
                clear.prop("id", "copyButton");
                clear.html('');
                GUI.addIcon(clear, "ui-icon-copy", "", "before");
                GUI.addTooltip({
                    parent: clear,
                    content: "copy URL to clipboard"
                });
            }
        };

        window.loadCss = function (item) {
            var link = "../gui/themes/" + item + "/jquery-ui.css";
            GUI.destroyCurrentCssTheme();
            GUI.loadCssFile(link);
            GUI.currentCssTheme = link;
            setTimeout(function () {
                GUI.setColorJqueryTheme();
                GUI.refreshJqueryTheme();
            }, 1000);
        }

        function pleaseWait(_displayMode, _parent) {
            if (_displayMode == true) {
                var mask = GUI.mask("mask-loading", "Please wait ...", _parent.jqueryObjectWest);
                GUI.image($('#mask-loading'), "img-loading", "../gui/images/loading.gif", 30, 30, "before");
                window.fl4reStatus('INFO', 'loading UI...', _parent.jqueryObjectSouth)
                return mask;
            } else if (_displayMode == false) {
                $('#mask-loading').remove();
                window.fl4reStatus('CLEAR', '', _parent.jqueryObjectSouth);
                // Conduit.viewportSetViewSize("default", layout.jqueryObjectWest.width() + 10, layout.jqueryObjectWest.height());
            }
        };

        var layout = GUI.Layout("mainLayout", 1);

        pleaseWait(true, layout);
        window.loadCss("vader");
        GUI.label("auteur", "&copy; rest3d 2014", layout.jqueryObjectSouth);
        CONSOLE.open(layout);

         ////////////
         // MAIN MENU

        var menu = GUI.menu({
            id: "menu",
            parent: layout.jqueryObjectNorth,
            item: [{
                text: "Load",
                id: "load"
            }, {
                text: "Settings",
                id: "settings"
            }, {
                text: "Themes UI",
                id: "themes"
            }, {
                text: "Support",
                id: "support"
            }, {
                text: "b",
                id: "fullscreen",
                callback: function () {
                    console.debug("fullscreen");
                },
            }]
        });

        GUI.mainMenu = menu;


         // --------------------------------------------------------- support and help -----------------------------------------------------------------------------

        var supportMenu = GUI.menu({
            id: "support-menu",
            parent: menu.support,
            item: [{
                id: "help-panel",
                text: "Help",
                callback: "window.onHelp()"
            }, {
                id: "google",
                text: "Google",
                callback: "window.onGithub()"
            }]
        })

         var helpPanel = $([]);

         //help dialog
        window.onHelp = function () {}

        var gitPanel = $([]);
        window.onGithub = function () {
            var gitHtml = '<div id="dialog"><iframe id="myIframe" src="" style="height:99% !important; width:99% !important; border:0px;"></iframe></div>';
            gitPanel = $('body').append(gitHtml);
            $("#dialog").dialog({
                autoOpen: true,
                width: 800,
                height: 600,
                open: function (ev, ui) {
                    $('#myIframe').attr('src', url);
                }
            });
        }

         //////////////
         // THEMES MENU

        var listCallback = [];
        var jsonTheme = {
            id: 'theme-menu',
            parent: menu.themes,
            item: []
        };
        for (var lgt = 0; lgt < listThemes.length; lgt++) {
            jsonTheme.item[lgt] = {
                text: listThemes[lgt],
                id: listThemes[lgt],
                callback: function (theme) {
                    return function () {
                        window.loadCss(theme);
                    }
                }(listThemes[lgt])

            };
        }
        var theme = GUI.menu(jsonTheme);
        theme.setAutoHeight();


         //------------------------------ all menu icons ---------------------------------------------------------------------------------------------

         // //add icons to the menu
        GUI.image(menu.load.text, "img-scenes", "../gui/images/menu-animations.gif", 15, 15, "before");
        GUI.image(menu.settings.text, "img-settings", "../gui/images/icon-cog.png", 15, 15, "before");
        GUI.image(menu.support.text, "img-help", "../gui/images/menu-help.png", 15, 15, "before");
        GUI.image(menu.themes.text, "img-themes", "../gui/images/jquery.png", 15, 15, "before");
        GUI.addIcon(menu.fullscreen.text, "ui-icon-arrow-4-diag", "position: relative !important; right:10px !important;bottom: 10px !important;", "before");
        menu.fullscreen.moveToRightFromLeft();
        menu.support.moveToRightFromLeft(25);
        menu.themes.moveToRightFromLeft();
        menu.settings.moveToRightFromLeft(220);

         //------------------------------//render menu ---------------------------------------------------------------------------------------------

        var renderMenu = GUI.tab({
            id: "renderMenus",
            parent: layout.jqueryObjectCenter,
            item: [{
                    id: "render",
                    text: "  Load DAE/glTF"
                }, {
                    id: "tree",
                    text: "  Explore warehouse"
                },

            ]
        })

         renderMenu.sortable();
        renderMenu.tabManager();

        GUI.image(renderMenu.render.title, "img-render", "../gui/images/menu-render.png", 12, 14, "before");

         //---------- SCRIPT tab --------------------------------------------------------------------------------------

        renderMenu.addTab({
            id: "script",
            text: "  Script"
        });

        var sample = "$('body').keypress(\n  function(e){\n  if (e.keyCode==113){\n//if key 'q' \n console.debug(e.keyCode)\n  //tape your code here \n } \n});";

        var script = GUI.script({
            id: "scriptArea",
            parent: renderMenu.script,
            content: sample
        });

        script.object.setSize("100%", "93%");
        renderMenu.refresh();

        var play;
        var stop;
        var clear;
        var help;
        var save;
        var load;

        GUI.image(renderMenu.script.title, "img-script", "../gui/images/script.png", 20, 14, "before");
        play = GUI.button("Play", renderMenu.script, function () {
            window.runStatus();
            window.interprate();
            script.parent.on('keyup', function () {
                window.interprate();
            })
            play.addClass("disablehide");
            stop.removeClass("disablehide");
            clear.addClass("disablehide");
            flagStatus = true;
            if (CONSOLE.flagError) {
                CONSOLE.flagError = false;
                window.errorStatus();
            }
        });
        play.html('');
        GUI.addIcon(play, "ui-icon-play", "", "before");
        GUI.addTooltip({
            parent: play,
            content: "Run script"
        });
        stop = GUI.button("Stop", renderMenu.script, function () {
            script.parent.off();
            play.removeClass("disablehide");
            stop.addClass("disablehide");
            clear.removeClass("disablehide");
            flagStatus = false;
            window.readyStatus();
        });
        stop.addClass("disablehide");
        stop.html('');
        GUI.addIcon(stop, "ui-icon-stop", "", "before");
        GUI.addTooltip({
            parent: stop,
            content: "Stop script"
        });
        clear = GUI.button("Clear", renderMenu.script, function () {
            script.parent.off();
            script.object.setValue(sample);
            script.object.clearHistory();
            window.readyStatus();
            flagStatus = false;
        });
        clear.html('');
        GUI.addIcon(clear, "ui-icon-trash", "", "before");
        GUI.addTooltip({
            parent: clear,
            content: "Clear script"
        });
        help = GUI.button("Help", renderMenu.script, function () {
            var html = "<dl><dt>Ctrl-F / Cmd-F</dt><dd>Start searching</dd><dt>Ctrl-G / Cmd-G</dt><dd>Find next</dd><dt>Shift-Ctrl-G / Shift-Cmd-G</dt><dd>Find previous</dd><dt>Shift-Ctrl-F / Cmd-Option-F</dt><dd>Replace</dd> <dt>Shift-Ctrl-R / Shift-Cmd-Option-F</dt><dd>Replace all</dd><dt>Ctrl-Space / Cmd-Space</dt><dd>Auto-complete</dd></dl>"
            GUI.notification({
                title: "Script hotkeys",
                text: html,
                type: "notice"
            })
        });
        help.html('');
        help.prop('id', "helpScript");
        GUI.addIcon(help, "ui-icon-note", "", "before");
        GUI.addTooltip({
            parent: help,
            content: "Hotkeys"
        });

        save = GUI.button("Save", renderMenu.script, function () {

        })
         save.html('');
        save.prop('id', "saveScript");
        GUI.addIcon(save, "ui-icon-disk", "", "before");
        GUI.addTooltip({
            parent: save,
            content: "Save current script"
        });

        var loadInput = GUI.input({
            id: "loadScript",
            parent: renderMenu.script,
            hide: true,
            extension: "application/javascript",
            mode: "readText",
            callback: function (FILE) {
                script.object.setValue(FILE.target.result);
                GUI.notification({
                    text: "Script loaded",
                    time: "5000",
                    type: "notice"
                });
            }
        });
        load = GUI.button("Load", renderMenu.script, function () {
            loadInput.click();
            script.refresh();
        });
        load.html('');
        GUI.addIcon(load, "ui-icon-folder-open", "", "before");
        GUI.addTooltip({
            parent: load,
            content: "Load script"
        });

        var runStatus = GUI.image(renderMenu.script, "traffic-light", "../gui/images/traffic-cone_blue.png", '20', '20');
        GUI.addTooltip({
            parent: runStatus,
            content: "Ready to run"
        })

         window.interprate = function () {
            //$('body').unbind();
            // $(document).unbind();
            window.runStatus();
            $('#scriptElement').remove();
            $('#scriptElement').empty();
            $('#scriptElement').html('');
            var js = script.object.getValue();
            var variable = document.createElement('script');
            variable.id = 'scriptElement';
            variable.textContent = js;
            document.body.appendChild(variable);
            if (CONSOLE.flagError) {
                CONSOLE.flagError = false;
                window.errorStatus();
            }
        }

        window.readyStatus = function () {
            runStatus.remove();
            runStatus = GUI.image(renderMenu.script, "traffic-light", "../gui/images/traffic-cone_blue.png", '20', '20');
            GUI.addTooltip({
                parent: runStatus,
                content: "Ready to run"
            })
        }

        window.errorStatus = function () {
            runStatus.remove();
            runStatus = GUI.image(renderMenu.script, "traffic-light", "../gui/images/traffic-cone_red.png", '20', '20');
            GUI.addTooltip({
                parent: runStatus,
                content: "Error detected into the script, please consult the console"
            });
        }

        window.runStatus = function () {
            runStatus.remove();
            runStatus = GUI.image(renderMenu.script, "traffic-light", "../gui/images/traffic-cone_green.png", '20', '20');
            GUI.addTooltip({
                parent: runStatus,
                content: "Running..."
            });
        }




         /////////////// VIEWER WEBGL WORKAROUD ///////////////////////////////////////////////
        var pmMatrix = mat4.create();
        var mvMatrixStack = [];
        var mvMatrix = mat4.create();
        var deg2rad = 0.0174532925; // constant
        var currentRotationX = 0;
        var currentRotationY = 0;
        var currentZoom = 1;
        var mainCamera = null;
        var scenes = [];


        var win = null;
        var canvas = null;
        var channel = null;

        var tree = null;
        var scene_tree = null;
        var warehouse_tree = null;

        function jumpLine() {
            renderMenu.render.append("<br></br>");
        }

        renderMenu.render.append("<h4>Welcome to rest3d's viewer!</h4>");

        GUI.label('welcome', "We are proposing a new version of our viewer elaborated with gui6. Thus, you are able to display below some model samples in COLLADA or glTF format:", renderMenu.render, "", "justify");
        jumpLine();
        var accordion = GUI.accordion({
            id: "menu-render",
            parent: renderMenu.render,
            item: [{
                id: "collada",
                text: "COLLADA"
            }, {
                id: "gltf",
                text: "glTF"
            }, ]
        })
         accordion.autoScrollDown();

        jumpLine();

        var button1 = GUI.button('Simulate Context Loss', renderMenu.render, function () {
            if ($(this).find('.ui-button-text').text() == "Simulate Context Loss") {
                channel.forceContextLoss();
                $(this).find('.ui-button-text').text("Simulate Restore Context");
            } else {
                channel.forceContextRestore();
                $(this).find('.ui-button-text').text("Simulate Context Loss");
            }
        });

        GUI.button('duck rest3d', accordion.collada, function () {
            COLLADA.load("/rest3d/assets/duck/duck.dae", parse_dae);
        }).width("90%");
        accordion.collada.append("<hr></hr>");
        GUI.button('duck', accordion.collada, function () {
            COLLADA.load("/models/duck/duck.dae", parse_dae);
        }).width("90%");
        accordion.collada.append("<hr></hr>");

        GUI.button('creature', accordion.collada, function () {
            COLLADA.load("/models/Amahani/Amahani.dae", parse_dae);
        }).width("90%");
        accordion.collada.append("<hr></hr>");

        GUI.button('duck', accordion.gltf, function () {
            glTF.load("/models/duck/duck.json", parse_gltf);
        }).width("90%");
        accordion.gltf.append("<hr></hr>");

        GUI.button('rambler', accordion.gltf, function () {
            glTF.load("/models/rambler/Rambler.json", parse_gltf);
        }).width("90%");
        accordion.gltf.append("<hr></hr>");

        GUI.button('rambler-min', accordion.collada, function () {
            COLLADA.load("/models/rambler/Rambler-min.dae", parse_gltf);
        }).width("90%");
        accordion.collada.append("<hr></hr>");

        GUI.button('rambler', accordion.collada, function () {
            COLLADA.load("/models/rambler/Rambler.dae", parse_dae);
        }).width("90%");
        accordion.collada.append("<hr></hr>");

        GUI.button('supermurdoch', accordion.collada, function () {
            COLLADA.load("/models/SuperMurdoch/SuperMurdoch.dae", parse_dae);
        }).width("90%");
        accordion.collada.append("<hr></hr>");

        GUI.button('supermurdoch', accordion.gltf, function () {
            glTF.load("/models/SuperMurdoch/SuperMurdoch.json", parse_gltf);
        }).width("90%");
        accordion.gltf.append("<hr></hr>");

        GUI.button('wine', accordion.collada, function () {
            COLLADA.load("/models/wine/wine.dae", parse_dae);
        }).width("90%");
        accordion.collada.append("<hr></hr>");

        GUI.button('wine', accordion.gltf, function () {
            glTF.load("/models/wine/wine.json", parse_gltf);
        }).width("90%");
        accordion.gltf.append("<hr></hr>");


        GUI.button('uh-1n', accordion.collada, function () {
            COLLADA.load("/models/uh-1n/uh-1n.dae", parse_dae);
        }).width("90%");
        accordion.collada.append("<hr></hr>");

        GUI.button('uh-1n', accordion.gltf, function () {
            glTF.load("/models/uh-1n/uh-1n.json", parse_gltf);
        }).width("90%");
        accordion.gltf.append("<hr></hr>");

        GUI.button('cow', accordion.collada, function () {
            COLLADA.load("/models/cow/cow.dae", parse_dae);
        }).width("90%");

        GUI.button('cow', accordion.gltf, function () {
            glTF.load("/models/cow/cow.json", parse_gltf);
        }).width("90%");


        canvas = GUI.canvas(layout.jqueryObjectWest);
         // layout.resetOverflow('west');

         // initialize webGL
        channel = Channel.create(canvas, true); // debug context please

        initCanvasUI();

        function parse_dae(dae) {

            // set the image load callback to redraw
            dae.onload = draw;

            var starttime = window.performance.now();
            // get the scene
            var scene = dae.parse_visual_scene(dae.sceneID);

            // pull out the Z-up flag
            scene.upAxis = dae.up_axis;
            if (!scene.upAxis) scene.upAxis = "Y_UP";

            // traverse the scene, collect the geometry and make webGL objects out of those

            function buildMe() {

                // this is the bounding box for all geometries instanced in this node
                var bounds = aabb.empty();

                if (!this.geometries || this.geometries.length === 0) return bounds;

                var geometries = this.geometries;
                // there can be several instance_geom per node
                // each instance is a single mesh
                // each mesh has several primitives


                for (var j = 0; j < geometries.length; j++) {
                    var geometry = geometries[j];

                    // each geometry has a mesh : an array of primitives
                    // and a glprimitives - whcih contains the webGL primitives for each primitives in the mesh
                    if (geometry.glprimitives) continue;
                    geometry.glprimitives = [];

                    // let's store the Type Arrays in each primitives

                    var primitives = geometry.mesh;

                    for (var p = 0; p < primitives.length; p++) {

                        var triangles = primitives[p];
                        // fill up my primitive structure
                        var primitive = {};
                        var position = null;
                        var normal = null;
                        var texcoord = null;
                        var color = null;

                        // speed-up function call

                        if (triangles.VERTEX) {
                            position = [];
                            var ppush = position.push;
                            var vget = triangles.VERTEX;
                            for (var i = 0; i < triangles.count * 3; ++i)
                                ppush.apply(position, vget.call(triangles, i));
                            primitive.position = new Float32Array(position);
                        }
                        if (triangles.NORMAL) {
                            normal = []
                            var npush = normal.push;
                            var nget = triangles.NORMAL;
                            for (var i = 0; i < triangles.count * 3; ++i)
                                npush.apply(normal, nget.call(triangles, i));
                            primitive.normal = new Float32Array(normal);
                        }
                        if (triangles.TEXCOORD_0) {
                            texcoord = [];
                            var tpush = texcoord.push;
                            var tget = triangles.TEXCOORD_0;
                            for (var i = 0; i < triangles.count * 3; ++i)
                                tpush.apply(texcoord, tget.call(triangles, i))
                            primitive.texcoord = new Float32Array(texcoord);
                        }

                        if (triangles.COLOR) {
                            color = [];
                            var cpush = color.push;
                            var cget = triangles.COLOR;
                            for (var i = 0; i < triangles.count * 3; ++i)
                                cpush.apply(color, cget.call(triangles, i))
                            primitive.color = new Float32Array(color);
                        }

                        primitive.index = null;

                        var state = State.createBasic();
                        var material = geometry.materials[p];

                        // check for a bind_vertex_input - this is for warning only
                        if (material.bind_vertex_input && material.bind_vertex_input.length !== 0) {
                            var param = null;
                            var bind_vertex_input = material.bind_vertex_input[0]
                            var set = bind_vertex_input.input_set || 0;
                            var input_semantic = bind_vertex_input.input_semantic + '_' + set;
                            var search = null;
                            for (var j = 0; j < state.program.attributes.length; j++) {
                                if (state.program.attributes[j].semantic === input_semantic) {
                                    search = bind_vertex_input.semantic;
                                    break;
                                }
                            }
                            // if not found, try with set = 0 
                            input_semantic = bind_vertex_input.input_semantic + '_0';

                            if (!search) {
                                for (var j = 0; j < state.program.attributes.length; j++) {
                                    if (state.program.attributes[j].semantic === input_semantic) {
                                        search = bind_vertex_input.semantic;
                                        break;
                                    }
                                }
                            }
                            if (!search) {
                                console.log('could not find attribute ' + bind_vertex_input.input_semantic + '_' + set +
                                    ' in primitive');
                            }
                        }

                        // only intersting paramter for that simple shader is the diffuse texture
                        if (material.parameters && typeof material.parameters.diffuse === 'object') {
                            var diffuse = material.parameters.diffuse;
                            if (!diffuse.texcoord) {
                                search = null;
                                for (var j = 0; j < state.program.attributes.length; j++) {
                                    if (state.program.attributes[j].semantic === 'COLOR') {
                                        search = state.program.attributes[j];
                                        break;
                                    }
                                }
                                if (diffuse.color) {
                                    search.value = diffuse.color;
                                } else {
                                    search.value = [1, 1, 1, 0.5];
                                }
                            } else if (search !== diffuse.texcoord) {
                                console.log('semantic ' + search + ' does not match diffuse semantic of ' + diffuse.texcoord);
                            } else if (diffuse && diffuse.image) {
                                state.program.uniforms['diffuse'].value = {
                                    "path": diffuse.path,
                                    "image": diffuse.image,
                                    "magFilter": diffuse.magFilter,
                                    "minFilter": diffuse.minFilter,
                                    "wrapS": diffuse.wrapS,
                                    "wrapT": diffuse.wrapT,
                                    "flipY": true,
                                    "textureUnit": 0
                                };
                            }
                        }
                        geometry.glprimitives.push(new RENDERER.primitive(primitive.position, primitive.color,
                            primitive.normal, null, primitive.texcoord, primitive.index, state));

                    }
                    // a mesh has a bounding box
                    aabb.add(bounds, bounds, geometry.mesh.bounds);
                }
                // we're done, return the calculated bounding box
                return bounds;
            };

            // depth first traversal, create primitives and bounding boxes

            scene.bounds = build_scene(scene, buildMe);

            mainCamera = Camera.create();
            Camera.lookAtAabb(mainCamera, scene.bounds, scene.upAxis);

            currentRotationX = currentRotationY = 0;
            clearStack();
            scene.starttime = starttime;
            scene.endtime = window.performance.now();

            scenes.push(scene);
            $('#loadtimer').text('load time=' + (scene.endtime - scene.starttime));
            draw();

        };

        function parse_gltf(gltf) {

            var starttime = window.performance.now();

            // set the image load callback to redraw
            gltf.onload = draw;
            // traverse the scene, collect the geometry and make webGL objects out of those
            function buildMe() {
                // this is the bounding box for all geometries instanced in this node
                var bounds = aabb.empty();
                if (!this.geometries || this.geometries.length === 0) return bounds;

                var geometries = this.geometries;
                // there can be several instance_geom per node
                // each instance is a single mesh
                // each mesh has several primitives




                for (var j = 0; j < geometries.length; j++) {
                    var geometry = geometries[j];

                    // each geometry has a mesh : an array of primitives
                    // and a glprimitives - whcih contains the webGL primitives for each primitives in the mesh
                    if (geometry.glprimitives) continue;
                    geometry.glprimitives = [];

                    // let's store the Type Arrays in each primitives

                    var primitives = geometry.mesh;
                    var materials = geometry.materials;

                    for (var i = 0; i < primitives.length; i++) {

                        var triangles = primitives[i];
                        var material = materials[i];

                        // create a new state with this material override
                        var state = State.fromPassAndOverrides(material.pass, material.overrides);
                        // fill up my primitive structure
                        var primitive = {};

                        primitive.position = triangles.POSITION;
                        primitive.normal = triangles.NORMAL;
                        primitive.texcoord = triangles.TEXCOORD_0;
                        primitive.index = triangles.INDEX;

                        geometry.glprimitives.push(new RENDERER.primitive(primitive.position, null, primitive.normal,
                            null, primitive.texcoord, primitive.index, state));

                    }
                    // a gltf mesh has a bounding box
                    aabb.add(bounds, bounds, primitives.bounds);
                }
                // we're done, return the calculated bounding box
                return bounds;
            };


            // get the scene
            var scene = gltf.parse_visual_scene(gltf.sceneID);
            scene.upAxis = "Y_UP";

            // depth first traversal, create primitives, states and bounding boxes

            scene.bounds = build_scene(scene, buildMe);


            mainCamera = Camera.create();
            Camera.lookAtAabb(mainCamera, scene.bounds, scene.upAxis);

            currentRotationX = currentRotationY = 0;
            clearStack();

            scene.starttime = starttime;
            scene.endtime = window.performance.now();
            $('#loadtimer').text('load time=' + (scene.endtime - scene.starttime));
            scenes.push(scene);
            draw();

        };

        function pushMatrix(m) {
            if (m) {
                mvMatrixStack.push(mat4.clone(m));
                mvMatrix = mat4.clone(m);
            } else {
                mvMatrixStack.push(mat4.clone(mvMatrix));
            }
        };

        function popMatrix() {
            if (mvMatrixStack.length == 0) throw "Invalid popMatrix!";
            mvMatrix = mvMatrixStack.pop();
            return mvMatrix;
        };

        function clearStack() {
            mvMatrixStack = [];
            mvMatrix = mat4.create();
        };


        function initCanvasUI() {

            GUI.label("currentZoom is 1", win, "zoom")
            GUI.label('rotation goes here', win, 'rot')
            GUI.label('loading time: 0', win, 'loadtimer');

            GUI.label('Initializing canvas mouse events', win);
            var mouseDown = false;
            var lastX, lastY = 0;
            // attach mouse events to canvas

            function mouseDownHandler(ev) {
                mouseDown = true;
                lastX = ev.screenX;
                lastY = ev.screenY;
                return true;
            }

            function mouseMoveHandler(ev) {
                if (!mouseDown) return false;

                currentZoom = 1;
                var mdelta = ev.screenX - lastX;
                lastX = ev.screenX;
                currentRotationX -= mdelta / 2.5;


                var mdelta = ev.screenY - lastY;
                lastY = ev.screenY;
                currentRotationY -= mdelta / 2.5;


                draw();
                return true;
            }

            function mouseUpHandler(ev) {
                mouseDown = false;
            }

            function mouseWheelHandler(ev) {

                var mdelta = ev.wheelDelta;
                currentZoom = Math.exp(mdelta / 2500);

                draw();
                return true;
            }

            canvas.removeEventListener("mousedown", mouseDownHandler, false);
            canvas.removeEventListener("mousemove", mouseMoveHandler, false);
            canvas.removeEventListener("mouseup", mouseUpHandler, false);
            canvas.removeEventListener("mousewheel", mouseWheelHandler, false);
            canvas.addEventListener("mousedown", mouseDownHandler, false);
            canvas.addEventListener("mousemove", mouseMoveHandler, false);
            canvas.addEventListener("mouseup", mouseUpHandler, false);
            canvas.addEventListener("mousewheel", mouseWheelHandler, false);

            GUI.label('Use left mouse click to rotate', win);
            GUI.label('Use mouse wheel to zoom', win);
            // redraw on resize

            $(canvas).resize(function (evt) {
                draw();
            });
        };


         // functions used by draw.
         // TODO - culling

        function drawnode() {
            if (!this.geometries || this.geometries.length == 0)
                return true;

            for (var j = 0, len = this.geometries.length; j < len; j++) {
                var primitives = this.geometries[j].glprimitives;
                if (primitives) {
                    State.setModelView(channel.state, mvMatrix);
                    for (var i = 0; i < primitives.length; i++)
                        primitives[i].render(channel);
                }
            }

            return true;
        }

        function render_scene(_nodes, _callback) {

            for (var j = 0, lenj = _nodes.length; j < lenj; j++) {
                var node = _nodes[j];

                pushMatrix();
                mat4.multiply(mvMatrix, mvMatrix, node.mat4);
                //State.setModelView(this.state,mvMatrix);

                if (node.children)
                    render_scene.call(this, node.children, _callback)

                var cont = _callback.call(node);

                popMatrix();
            }


            return cont;
        };

        function draw() {

            if (!scenes || scenes.length < 1) return;



            $('#zoom').text('currentZoom is ' + currentZoom);
            $('#rot').text('currentRotation is ' + currentRotationX + ',' + currentRotationY);

            var devicePixelRatio = window.devicePixelRatio || 1;

            // set the size of the drawingBuffer based on the size it's displayed.
            canvas.width = canvas.clientWidth * devicePixelRatio;
            canvas.height = canvas.clientHeight * devicePixelRatio;
            var width = canvas.width;
            var height = canvas.height;


            channel.viewport(0, 0, width, height);
            channel.clear();



            Camera.rotateAround(mainCamera, currentZoom, currentRotationX, currentRotationY);

            mat4.multiply(pmMatrix, mainCamera.projection, mainCamera.lookAt);

            var state = channel.state;

            for (var i = 0; i < scenes.length; i++) {
                pushMatrix();

                if (scenes[i].upAxis === 'Z_UP') {
                    mat4.rotate(mvMatrix, mvMatrix, -90 * deg2rad, vec3.fromValues(1, 0, 0));
                };

                //State.setModelView(state,mvMatrix);
                State.setViewProj(state, pmMatrix);

                // depth first scene drawing
                render_scene.call(channel, scenes[i], drawnode);

                popMatrix();

            }

        };

        function build_scene(_nodes, _callback) {
            var bounds = aabb.empty();
            for (var j = 0; j < _nodes.length; j++) {
                var node = _nodes[j];

                var nodebb = aabb.empty();;
                if (node.children && node.children.length !== 0)
                    aabb.add(nodebb, nodebb,
                        build_scene(node.children, _callback));

                aabb.add(nodebb, nodebb,
                    _callback.call(node));

                aabb.transform(nodebb, nodebb, node.mat4);
                aabb.add(bounds, bounds, nodebb);
            }
            return bounds;
        };


         /////////////////////////////////////////////////////////////////////////////////////

        $('#tabindex_2').find('input').click();
        $('#tabindex_1').find('input').click();

        layout.jqueryObject.sizePane("west", $(window).width() - 300);
        setTimeout(function () {
            layout.jqueryObject.sizePane("west", $(window).width() - 299);
        }, 1000);

        layout.jqueryObject.resizeAll();
        layout.jqueryObject.initContent("center");
        layout.jqueryObject.initContent("west");


        pleaseWait(false, layout);

        });

        
         </script>
</head>
<body oncontextmenu="return false"></body>
